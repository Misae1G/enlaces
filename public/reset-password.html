<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restablecer ContraseÃ±a - DEBUG MODE</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Estilos para el panel de logs */
    #debugPanel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1a1a1a;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      padding: 15px;
      border-top: 3px solid #00ff00;
      z-index: 9999;
    }
    
    #debugPanel.collapsed {
      max-height: 40px;
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #00ff00;
      padding-left: 10px;
    }
    
    .log-entry.error {
      color: #ff4444;
      border-left-color: #ff4444;
    }
    
    .log-entry.warning {
      color: #ffaa00;
      border-left-color: #ffaa00;
    }
    
    .log-entry.success {
      color: #00ff00;
      border-left-color: #00ff00;
    }
    
    .log-entry.info {
      color: #00aaff;
      border-left-color: #00aaff;
    }
    
    .log-timestamp {
      color: #888;
      margin-right: 10px;
    }
    
    .log-details {
      margin-left: 20px;
      color: #aaa;
      font-size: 11px;
    }
    
    #toggleDebug {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #333;
      color: #00ff00;
      border: 1px solid #00ff00;
      padding: 5px 15px;
      cursor: pointer;
      border-radius: 4px;
    }
    
    #clearLogs {
      position: absolute;
      top: 10px;
      right: 100px;
      background: #333;
      color: #ff4444;
      border: 1px solid #ff4444;
      padding: 5px 15px;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .json-viewer {
      background: #2a2a2a;
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <!-- Panel de Debug -->
  <div id="debugPanel">
    <button id="toggleDebug">Minimizar</button>
    <button id="clearLogs">Limpiar</button>
    <div id="logContainer"></div>
  </div>

  <div class="container">
    <div class="card">
      <div class="header">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
        </svg>
        <h1>Restablecer ContraseÃ±a</h1>
        <p class="subtitle">Ingresa tu nueva contraseÃ±a</p>
        <p style="color: #ff4444; font-size: 11px; margin-top: 10px;">ğŸ› DEBUG MODE ACTIVADO</p>
      </div>

      <div id="message"></div>

      <form id="resetForm" style="display: none;">
        <div class="form-group">
          <label>Nueva ContraseÃ±a</label>
          <input type="password" id="password" required 
                 placeholder="MÃ­nimo 6 caracteres">
        </div>

        <div class="form-group">
          <label>Confirmar ContraseÃ±a</label>
          <input type="password" id="confirmPassword" required 
                 placeholder="Repite tu contraseÃ±a">
        </div>

        <button type="submit" class="btn" id="submitBtn">
          Cambiar ContraseÃ±a
        </button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ==========================================
    // SISTEMA DE LOGGING DETALLADO
    // ==========================================
    
    const logContainer = document.getElementById('logContainer');
    const debugPanel = document.getElementById('debugPanel');
    let logCount = 0;
    
    // FunciÃ³n para agregar logs con colores y detalles
    function addLog(message, type = 'info', details = null) {
      logCount++;
      const timestamp = new Date().toLocaleTimeString('es-ES', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
      
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${type}`;
      
      let logHTML = `<span class="log-timestamp">[${timestamp}]</span><strong>#${logCount}</strong> ${message}`;
      
      if (details) {
        if (typeof details === 'object') {
          logHTML += `<div class="log-details"><div class="json-viewer">${JSON.stringify(details, null, 2)}</div></div>`;
        } else {
          logHTML += `<div class="log-details">${details}</div>`;
        }
      }
      
      logEntry.innerHTML = logHTML;
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
      
      // TambiÃ©n loguear en consola
      console.log(`[${type.toUpperCase()}] ${message}`, details || '');
    }
    
    // Botones del panel de debug
    document.getElementById('toggleDebug').addEventListener('click', function() {
      debugPanel.classList.toggle('collapsed');
      this.textContent = debugPanel.classList.contains('collapsed') ? 'Expandir' : 'Minimizar';
    });
    
    document.getElementById('clearLogs').addEventListener('click', function() {
      logContainer.innerHTML = '';
      logCount = 0;
      addLog('Logs limpiados', 'info');
    });
    
    // ==========================================
    // CONFIGURACIÃ“N DE SUPABASE
    // ==========================================
    
    const SUPABASE_URL = 'https://ilzyyicbqlqbmyjcrhsd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsenl5aWNicWxxYm15amNyaHNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMTUwMDcsImV4cCI6MjA4MDg5MTAwN30.oRKWOMHgQCXo751SmDXVtdbNZ1xEq17z5gXBdXKswUg';

    addLog('ğŸš€ Iniciando aplicaciÃ³n de reset de contraseÃ±a', 'info');
    addLog('ConfiguraciÃ³n de Supabase', 'info', {
      url: SUPABASE_URL,
      key: SUPABASE_KEY.substring(0, 20) + '...'
    });

    const { createClient } = supabase;
    
    // VERSIÃ“N ACTUAL (PKCE) - Vamos a probar ambas
    addLog('ğŸ“¦ Creando cliente Supabase con PKCE (versiÃ³n actual)', 'info');
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // VERSIÃ“N IMPLICIT (alternativa)
    addLog('ğŸ“¦ Creando cliente Supabase con Implicit Flow (versiÃ³n alternativa)', 'info');
    const supabaseImplicit = createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: {
        flowType: 'implicit',
        autoRefreshToken: false,
        detectSessionInUrl: true,
      }
    });

    const form = document.getElementById('resetForm');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const messageDiv = document.getElementById('message');
    const submitBtn = document.getElementById('submitBtn');

    // FunciÃ³n para mostrar mensajes en la UI
    function showMessage(text, type) {
      messageDiv.innerHTML = `<div class="${type}">${text}</div>`;
      addLog(`Mensaje UI: ${text}`, type === 'error' ? 'error' : 'success');
    }

    // ==========================================
    // ANÃLISIS DETALLADO DE LA URL
    // ==========================================
    
    function analyzeURL() {
      addLog('ğŸ” ANÃLISIS COMPLETO DE LA URL', 'info');
      
      const fullURL = window.location.href;
      const pathname = window.location.pathname;
      const search = window.location.search;
      const hash = window.location.hash;
      
      addLog('URL completa', 'info', fullURL);
      addLog('Pathname', 'info', pathname);
      addLog('Search (query params)', 'info', search || '(vacÃ­o)');
      addLog('Hash', 'info', hash || '(vacÃ­o)');
      
      // Analizar query params
      if (search) {
        const searchParams = new URLSearchParams(search);
        const params = {};
        for (const [key, value] of searchParams.entries()) {
          params[key] = value;
        }
        addLog('Query Parameters encontrados', 'success', params);
        
        // Verificar parÃ¡metros especÃ­ficos
        if (searchParams.has('code')) {
          addLog('âœ… ParÃ¡metro "code" encontrado', 'success', {
            code: searchParams.get('code').substring(0, 20) + '...',
            length: searchParams.get('code').length
          });
        } else {
          addLog('âŒ ParÃ¡metro "code" NO encontrado', 'error');
        }
        
        if (searchParams.has('type')) {
          addLog('âœ… ParÃ¡metro "type" encontrado', 'success', {
            type: searchParams.get('type')
          });
        } else {
          addLog('âš ï¸ ParÃ¡metro "type" NO encontrado', 'warning');
        }
      } else {
        addLog('âŒ No hay query parameters en la URL', 'error');
      }
      
      // Analizar hash params
      if (hash) {
        const hashParams = new URLSearchParams(hash.substring(1));
        const params = {};
        for (const [key, value] of hashParams.entries()) {
          params[key] = value.substring(0, 20) + '...';
        }
        addLog('Hash Parameters encontrados', 'success', params);
        
        if (hashParams.has('access_token')) {
          addLog('âœ… Access Token encontrado en hash', 'success', {
            length: hashParams.get('access_token').length
          });
        }
        
        if (hashParams.has('refresh_token')) {
          addLog('âœ… Refresh Token encontrado en hash', 'success');
        }
      } else {
        addLog('âŒ No hay hash parameters en la URL', 'error');
      }
      
      return { search, hash };
    }

    // ==========================================
    // VERIFICACIÃ“N DE SESIÃ“N CON LOGGING DETALLADO
    // ==========================================
    
    async function checkSession() {
      try {
        addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
        addLog('ğŸ” INICIANDO VERIFICACIÃ“N DE SESIÃ“N', 'info');
        addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
        
        // Analizar URL
        const { search, hash } = analyzeURL();
        
        // MÃ‰TODO 1: Intentar con PKCE (exchangeCodeForSession)
        addLog('', 'info');
        addLog('ğŸ“‹ MÃ‰TODO 1: Intentando PKCE Flow', 'info');
        
        if (search.includes('code=')) {
          const searchParams = new URLSearchParams(search);
          const code = searchParams.get('code');
          const type = searchParams.get('type') || 'desconocido';
          
          addLog('Intentando exchangeCodeForSession con PKCE...', 'info', {
            code_length: code.length,
            type: type
          });
          
          try {
            const { data: pkceData, error: pkceError } = await supabaseClient.auth.exchangeCodeForSession(code);
            
            if (pkceError) {
              addLog('âŒ Error en PKCE Flow', 'error', {
                message: pkceError.message,
                status: pkceError.status,
                name: pkceError.name,
                code: pkceError.code,
                details: pkceError
              });
              
              // Si el error es de PKCE, explicarlo
              if (pkceError.message.includes('code verifier')) {
                addLog('ğŸ”´ ERROR IDENTIFICADO: PKCE code verifier faltante', 'error');
                addLog('ExplicaciÃ³n: El cÃ³digo fue generado en Flutter, pero el code_verifier se quedÃ³ allÃ­', 'warning');
                addLog('SoluciÃ³n: Necesitas usar Implicit Flow en vez de PKCE', 'warning');
              }
            } else {
              addLog('âœ… PKCE Flow exitoso!', 'success', {
                user_id: pkceData.user?.id,
                email: pkceData.user?.email
              });
              return true;
            }
          } catch (err) {
            addLog('ğŸ’¥ ExcepciÃ³n en PKCE Flow', 'error', {
              message: err.message,
              stack: err.stack
            });
          }
        } else {
          addLog('âš ï¸ No hay cÃ³digo en la URL para intentar PKCE', 'warning');
        }
        
        // MÃ‰TODO 2: Intentar con verifyOtp (recovery)
        addLog('', 'info');
        addLog('ğŸ“‹ MÃ‰TODO 2: Intentando verifyOtp (recovery)', 'info');
        
        if (search.includes('code=')) {
          const searchParams = new URLSearchParams(search);
          const code = searchParams.get('code');
          const type = searchParams.get('type');
          
          if (type === 'recovery') {
            addLog('Intentando verifyOtp con type=recovery...', 'info');
            
            try {
              const { data: otpData, error: otpError } = await supabaseClient.auth.verifyOtp({
                token_hash: code,
                type: 'recovery'
              });
              
              if (otpError) {
                addLog('âŒ Error en verifyOtp', 'error', {
                  message: otpError.message,
                  status: otpError.status,
                  details: otpError
                });
              } else {
                addLog('âœ… verifyOtp exitoso!', 'success', {
                  user_id: otpData.user?.id,
                  email: otpData.user?.email
                });
                return true;
              }
            } catch (err) {
              addLog('ğŸ’¥ ExcepciÃ³n en verifyOtp', 'error', {
                message: err.message,
                stack: err.stack
              });
            }
          } else {
            addLog('âš ï¸ type no es "recovery", saltando verifyOtp', 'warning', { type });
          }
        }
        
        // MÃ‰TODO 3: Intentar con Implicit Flow (hash tokens)
        addLog('', 'info');
        addLog('ğŸ“‹ MÃ‰TODO 3: Intentando Implicit Flow (hash)', 'info');
        
        if (hash) {
          addLog('Intentando leer sesiÃ³n con Implicit Flow...', 'info');
          
          try {
            const { data: implicitData, error: implicitError } = await supabaseImplicit.auth.getSession();
            
            if (implicitError) {
              addLog('âŒ Error en Implicit Flow', 'error', {
                message: implicitError.message,
                details: implicitError
              });
            } else if (implicitData.session) {
              addLog('âœ… Implicit Flow exitoso!', 'success', {
                user_id: implicitData.session.user?.id,
                email: implicitData.session.user?.email,
                expires_at: new Date(implicitData.session.expires_at * 1000).toLocaleString()
              });
              
              // Usar el cliente implicit de aquÃ­ en adelante
              window.activeClient = supabaseImplicit;
              return true;
            } else {
              addLog('âš ï¸ No hay sesiÃ³n en Implicit Flow', 'warning');
            }
          } catch (err) {
            addLog('ğŸ’¥ ExcepciÃ³n en Implicit Flow', 'error', {
              message: err.message,
              stack: err.stack
            });
          }
        } else {
          addLog('âš ï¸ No hay hash en la URL para intentar Implicit Flow', 'warning');
        }
        
        // MÃ‰TODO 4: Verificar si ya hay una sesiÃ³n existente
        addLog('', 'info');
        addLog('ğŸ“‹ MÃ‰TODO 4: Verificando sesiÃ³n existente', 'info');
        
        try {
          const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSession();
          
          if (sessionError) {
            addLog('âŒ Error al obtener sesiÃ³n', 'error', sessionError);
          } else if (sessionData.session) {
            addLog('âœ… Ya existe una sesiÃ³n activa!', 'success', {
              user_id: sessionData.session.user?.id,
              email: sessionData.session.user?.email
            });
            return true;
          } else {
            addLog('âš ï¸ No hay sesiÃ³n activa', 'warning');
          }
        } catch (err) {
          addLog('ğŸ’¥ ExcepciÃ³n al verificar sesiÃ³n', 'error', err);
        }
        
        // Si llegamos aquÃ­, ningÃºn mÃ©todo funcionÃ³
        addLog('', 'info');
        addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'error');
        addLog('âŒ NINGÃšN MÃ‰TODO FUNCIONÃ“', 'error');
        addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'error');
        
        throw new Error('No se pudo establecer sesiÃ³n con ningÃºn mÃ©todo');

      } catch (err) {
        addLog('ğŸ’€ Error fatal en checkSession', 'error', {
          message: err.message,
          stack: err.stack
        });
        
        showMessage('âš ï¸ El enlace es invÃ¡lido, ha expirado o ya fue usado. Por favor solicita un nuevo enlace de recuperaciÃ³n.', 'error');
        form.style.display = 'none';
        return false;
      }
    }

    // ==========================================
    // MANEJO DEL FORMULARIO
    // ==========================================
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      addLog('ğŸ“ Formulario enviado', 'info');
      
      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      // Validaciones
      if (password.length < 6) {
        addLog('âŒ ValidaciÃ³n fallÃ³: ContraseÃ±a muy corta', 'error', { length: password.length });
        showMessage('âš ï¸ La contraseÃ±a debe tener al menos 6 caracteres', 'error');
        return;
      }

      if (password !== confirmPassword) {
        addLog('âŒ ValidaciÃ³n fallÃ³: ContraseÃ±as no coinciden', 'error');
        showMessage('âš ï¸ Las contraseÃ±as no coinciden', 'error');
        return;
      }
      
      addLog('âœ… Validaciones pasadas', 'success');

      // Deshabilitar botÃ³n
      submitBtn.disabled = true;
      submitBtn.textContent = 'Cambiando...';
      
      addLog('ğŸ”„ Intentando actualizar contraseÃ±a...', 'info');

      try {
        // Usar el cliente activo (puede ser PKCE o Implicit)
        const clientToUse = window.activeClient || supabaseClient;
        addLog('Cliente utilizado', 'info', {
          type: window.activeClient ? 'Implicit' : 'PKCE'
        });
        
        const { data, error } = await clientToUse.auth.updateUser({
          password: password
        });

        if (error) {
          throw error;
        }

        addLog('âœ… ContraseÃ±a actualizada exitosamente!', 'success', {
          user_id: data.user?.id,
          email: data.user?.email
        });
        
        // Cerrar sesiÃ³n
        addLog('ğŸ”’ Cerrando sesiÃ³n por seguridad...', 'info');
        await clientToUse.auth.signOut();
        addLog('âœ… SesiÃ³n cerrada', 'success');
        
        // Mostrar mensaje de Ã©xito
        form.style.display = 'none';
        showMessage('âœ… Â¡ContraseÃ±a actualizada correctamente!<br><br>Puedes cerrar esta ventana e iniciar sesiÃ³n con tu nueva contraseÃ±a.', 'success');

        // Limpiar la URL
        window.history.replaceState(null, '', window.location.pathname);
        addLog('ğŸ§¹ URL limpiada por seguridad', 'info');

      } catch (error) {
        addLog('âŒ Error al actualizar contraseÃ±a', 'error', {
          message: error.message,
          status: error.status,
          code: error.code,
          details: error
        });
        
        showMessage(`âŒ Error: ${error.message}`, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Cambiar ContraseÃ±a';
      }
    });

    // ==========================================
    // INICIALIZACIÃ“N
    // ==========================================
    
    window.addEventListener('DOMContentLoaded', async () => {
      addLog('ğŸ¬ DOMContentLoaded - Iniciando proceso', 'info');
      addLog('Navegador', 'info', {
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform
      });
      
      showMessage('ğŸ”„ Verificando enlace...', 'success');
      
      const ok = await checkSession();

      if (ok) {
        addLog('âœ… SesiÃ³n establecida correctamente', 'success');
        addLog('ğŸ‘‰ Mostrando formulario al usuario', 'info');
        messageDiv.innerHTML = '';
        form.style.display = 'block';
      } else {
        addLog('âŒ No se pudo establecer sesiÃ³n', 'error');
        addLog('ğŸ‘‰ Formulario oculto', 'info');
      }
      
      addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
      addLog('ğŸ Proceso de inicializaciÃ³n completado', 'info');
      addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    });
  </script>
</body>
</html>